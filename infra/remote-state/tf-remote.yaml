---
apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: aws-s3-bucket
  namespace: flux-system
spec:
  path: terraform/remote-state
  sourceRef:
    kind: GitRepository
    name: global-config
  approvePlan: auto
  retryInterval: 1m
  interval: 1h
  destroyResourcesOnDeletion: true
  writeOutputsToSecret:
    name: aws-s3-bucket-outputs
    outputs:
    - arn
    - bucket
  vars:
    - name: bucket_name
      value: ${prefixName}-${awsAccountId}-${awsRegion}-tf-state
    - name: tags
      value:
        creator: ${awsTagCreator}
        customer: ${awsTagCustomer}
        projectGid: ${awsTagProjectGid}
  runnerPodTemplate:
    spec:
      envFrom:
      - secretRef:
          name: aws-creds
---
apiVersion: infra.contrib.fluxcd.io/v1alpha2
kind: Terraform
metadata:
  name: aws-dynamo-table
  namespace: flux-system
  labels:
    tf.weave.works/composite: dynamodb-table
spec:
  path: aws_dynamodb_table
  values:
    name: ${prefixName}-${awsAccountId}-${awsRegion}-tf-state
    attribute:
    - name: LockID
      type: S
    hash_key: LockID
    read_capacity: 5
    write_capacity: 5
    tags:
      creator: ${awsTagCreator}
      customer: ${awsTagCustomer}
      projectGid: ${awsTagProjectGid}
      Name: state-bucket
  sourceRef:
    kind: OCIRepository
    name: aws-package
  approvePlan: auto
  retryInterval: 10s
  interval: 2m
  destroyResourcesOnDeletion: true
  writeOutputsToSecret:
    name: aws-dymamo-table-outputs
    outputs:
    - arn
  runnerPodTemplate:
    spec:
      envFrom:
      - secretRef:
          name: aws-creds